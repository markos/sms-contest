<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>sqltable.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; </center>
<hr><h1>sqltable.h</h1><a href="sqltable_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/***************************************************************************</span>
00002 <span class="comment">                          sqltable.h  -  description</span>
00003 <span class="comment">                             -------------------</span>
00004 <span class="comment">    begin                : Fri Aug 30 2002</span>
00005 <span class="comment">    copyright            : (C) 2002 Bullet S.A.</span>
00006 <span class="comment">    creator              : Konstantinos Margaritis</span>
00007 <span class="comment">    email                : markos@bullet.gr</span>
00008 <span class="comment"> ***************************************************************************/</span>
00009 
00010 <span class="preprocessor">#ifndef SQLTABLE_H</span>
00011 <span class="preprocessor"></span><span class="preprocessor">#define SQLTABLE_H</span>
00012 <span class="preprocessor"></span>
00013 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00014 
00060 <span class="preprocessor">#include &lt;sstream&gt;</span>
00061 <span class="preprocessor">#include &lt;vector&gt;</span>
00062 <span class="preprocessor">#include &lt;map&gt;</span>
00063 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00064 <span class="preprocessor">#include &lt;ace/OS.h&gt;</span>
00065 
00066 <span class="preprocessor">#include "<a class="code" href="sqliteconnection_8h.html">sqliteconnection.h</a>"</span>
00067 <span class="preprocessor">#include "<a class="code" href="timeperiod_8h.html">timeperiod.h</a>"</span>
00068 
<a name="l00069"></a><a class="code" href="classSQLTable.html">00069</a> <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; <span class="keyword">class </span><a class="code" href="classSQLTable.html">SQLTable</a> {
<a name="l00071"></a><a class="code" href="classSQLTable.html#SQLTableo0">00071</a>     <span class="keywordtype">bool</span> <a class="code" href="classSQLTable.html#SQLTableo0">ready</a>;
00072 
<a name="l00074"></a><a class="code" href="classSQLTable.html#SQLTableo1">00074</a>     <a class="code" href="classSQLiteConnection.html">SQLiteConnection</a> *<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>;
00075 
<a name="l00077"></a><a class="code" href="classSQLTable.html#SQLTableo2">00077</a>     string <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>;
00078 
<a name="l00080"></a><a class="code" href="classSQLTable.html#SQLTableo3">00080</a>   string <a class="code" href="classSQLTable.html#SQLTableo3">indexname</a>;
00081 
<a name="l00083"></a><a class="code" href="classSQLTable.html#SQLTableo4">00083</a>   string <a class="code" href="classSQLTable.html#SQLTableo4">tsname</a>;
00084 
<a name="l00086"></a><a class="code" href="classSQLTable.html#SQLTableo5">00086</a>   vector&lt;string&gt; <a class="code" href="classSQLTable.html#SQLTableo5">fieldnames</a>;
00087 
<a name="l00089"></a><a class="code" href="classSQLTable.html#SQLTableo6">00089</a>   vector&lt;string&gt; <a class="code" href="classSQLTable.html#SQLTableo6">fieldtypes</a>;
00090 
<a name="l00092"></a><a class="code" href="classSQLTable.html#SQLTableo7">00092</a>   vector&lt;string&gt; <a class="code" href="classSQLTable.html#SQLTableo7">indices</a>;
00093 
<a name="l00095"></a><a class="code" href="classSQLTable.html#SQLTableo8">00095</a>     <span class="keywordtype">bool</span> <a class="code" href="classSQLTable.html#SQLTableo8">hasPrimaryKey</a>;
00096 
<a name="l00098"></a><a class="code" href="classSQLTable.html#SQLTableu0">00098</a>     <span class="keyword">typedef</span> map&lt;key, vector&lt;data&gt; &gt; <a class="code" href="classSQLTable.html#SQLTableu0">sqlmap</a>;
00099 <span class="keyword">public</span>:
00100 
<a name="l00102"></a><a class="code" href="classSQLTable.html#SQLTablea0">00102</a>   <a class="code" href="classSQLTable.html#SQLTablea0">SQLTable</a>() { <a class="code" href="classSQLTable.html#SQLTableo0">ready</a> = <span class="keyword">false</span>; }
00103   
00105     <a class="code" href="classSQLTable.html#SQLTablea0">SQLTable</a>(<a class="code" href="classSQLiteConnection.html">SQLiteConnection</a> *db,
00106                         <span class="keyword">const</span> string &amp;tname, <span class="keyword">const</span> string &amp;iname,
00107                         <span class="keyword">const</span> string &amp;ts, vector&lt;string&gt; &amp;fnames,
00108             vector&lt;string&gt; &amp;ftypes, vector&lt;string&gt; &amp;indexnames, <span class="keywordtype">bool</span> primarykey);
00109 
00111     <a class="code" href="classSQLTable.html#SQLTablea0">SQLTable</a>(<span class="keyword">const</span> <a class="code" href="classSQLTable.html">SQLTable</a> &amp;source);
00112 
00114     <a class="code" href="classSQLTable.html">SQLTable</a> &amp;<a class="code" href="classSQLTable.html#SQLTablea3">operator=</a>(<span class="keyword">const</span> <a class="code" href="classSQLTable.html">SQLTable</a> &amp;source);
00115 
<a name="l00117"></a><a class="code" href="classSQLTable.html#SQLTablea4">00117</a>     <a class="code" href="classSQLTable.html#SQLTablea4">~SQLTable</a>() { };
00118 
00120   <span class="keywordtype">bool</span> <a class="code" href="classSQLTable.html#SQLTablea5">createIndices</a>();
00121 
00123     <span class="keywordtype">bool</span> <a class="code" href="classSQLTable.html#SQLTablea6">drop</a>();
00124 
00126     pair&lt;key, data&gt; <a class="code" href="classSQLTable.html#SQLTablea7">selectObject</a>(size_t index);
00127 
00129     data <a class="code" href="classSQLTable.html#SQLTablea7">selectObject</a>(key val, <span class="keyword">const</span> string &amp;iname);
00130 
00132     map&lt;key, data&gt; * <a class="code" href="classSQLTable.html#SQLTablea9">selectObjects</a>(<span class="keyword">const</span> key &amp;from, <span class="keyword">const</span> key &amp;to, <span class="keyword">const</span> string &amp;iname);
00133 
00135     map&lt;key, data&gt; * <a class="code" href="classSQLTable.html#SQLTablea9">selectObjects</a>(<a class="code" href="classTimePeriod.html">TimePeriod</a> &amp;tp);
00136 
00138     map&lt;key, data&gt; * <a class="code" href="classSQLTable.html#SQLTablea9">selectObjects</a>( <a class="code" href="classTimeStamp.html">TimeStamp</a> &amp;ts, <span class="keyword">const</span> string &amp;tpprefix,
00139                                                                         <span class="keyword">const</span> string &amp;qtyname);
00140 
00142     map&lt;key, data&gt; * <a class="code" href="classSQLTable.html#SQLTablea9">selectObjects</a>(vector&lt;key&gt; &amp;objs, <span class="keyword">const</span> string &amp;iname);
00143 
00145     map&lt;key, data&gt; * <a class="code" href="classSQLTable.html#SQLTablea13">selectAllObjects</a>();
00146 
00148     map&lt;key, data&gt; * <a class="code" href="classSQLTable.html#SQLTablea14">selectDistinctObjects</a>(<a class="code" href="classTimePeriod.html">TimePeriod</a> &amp;tp, <span class="keyword">const</span> string &amp;iname);
00149 
00151     map&lt;key, data&gt; * <a class="code" href="classSQLTable.html#SQLTablea14">selectDistinctObjects</a>(<span class="keyword">const</span> string &amp;iname);
00152 
00154     <span class="keywordtype">void</span> <a class="code" href="classSQLTable.html#SQLTablea16">selectDistinctObjectsMap</a>(ostream&amp; out, <a class="code" href="classTimePeriod.html">TimePeriod</a> &amp;tp, <span class="keyword">const</span> string &amp;iname);
00155 
00157     <span class="keywordtype">void</span> <a class="code" href="classSQLTable.html#SQLTablea16">selectDistinctObjectsMap</a>(ostream&amp; out, <span class="keyword">const</span> string &amp;iname);
00158 
00160     <span class="keywordtype">void</span> <a class="code" href="classSQLTable.html#SQLTablea18">insertObject</a>(key val, data &amp;obj);
00161 
00163     <span class="keywordtype">void</span> <a class="code" href="classSQLTable.html#SQLTablea19">insertObjects</a>(map&lt;key, data&gt; &amp;objs);
00164 
00166     <span class="keywordtype">void</span> <a class="code" href="classSQLTable.html#SQLTablea20">updateObject</a>(<span class="keyword">const</span> key &amp;val, data &amp;obj, <span class="keyword">const</span> string &amp;iname);
00167 
00169     <span class="keywordtype">void</span> <a class="code" href="classSQLTable.html#SQLTablea21">updateObjects</a>(map&lt;key, data&gt; &amp;objs, <span class="keyword">const</span> string &amp;iname);
00170 
00172     <span class="keywordtype">void</span> <a class="code" href="classSQLTable.html#SQLTablea22">deleteObject</a>(key &amp;val, <span class="keyword">const</span> string &amp;iname);
00173 
00175     <span class="keywordtype">void</span> <a class="code" href="classSQLTable.html#SQLTablea23">deleteObjects</a>(<span class="keyword">const</span> key &amp;from, <span class="keyword">const</span> key &amp;to, <span class="keyword">const</span> string &amp;iname);
00176 
00178     <span class="keywordtype">void</span> <a class="code" href="classSQLTable.html#SQLTablea23">deleteObjects</a>(vector&lt;key&gt; &amp;objs, <span class="keyword">const</span> string &amp;iname);
00179 
00181     size_t <a class="code" href="classSQLTable.html#SQLTablea29">size</a>(key val, <span class="keyword">const</span> string &amp;iname);
00182 
00184     size_t <a class="code" href="classSQLTable.html#SQLTablea29">size</a>(key from, key to, <span class="keyword">const</span> string &amp;iname);
00185 
00187     size_t <a class="code" href="classSQLTable.html#SQLTablea29">size</a>(<a class="code" href="classTimePeriod.html">TimePeriod</a> &amp;tp);
00188 
00190     size_t <a class="code" href="classSQLTable.html#SQLTablea29">size</a>(<span class="keyword">const</span> <a class="code" href="classTimeStamp.html">TimeStamp</a> &amp;ts, <span class="keyword">const</span> string &amp;tpprefix, <span class="keyword">const</span> string &amp;qtyname);
00191 
00193     size_t <a class="code" href="classSQLTable.html#SQLTablea29">size</a>();
00194 
00196     size_t <a class="code" href="classSQLTable.html#SQLTablea30">sizeofDistinctObjects</a>(<a class="code" href="classTimePeriod.html">TimePeriod</a> &amp;tp, <span class="keyword">const</span> string &amp;iname);
00197 
00199     size_t <a class="code" href="classSQLTable.html#SQLTablea30">sizeofDistinctObjects</a>(<span class="keyword">const</span> string &amp;iname);
00200 
00202     string <a class="code" href="classSQLTable.html#SQLTablea32">sumColumn</a>(key from, key to, <span class="keyword">const</span> string &amp;iname, <span class="keyword">const</span> string &amp;colname);
00203 
00205     string <a class="code" href="classSQLTable.html#SQLTablea32">sumColumn</a>(<a class="code" href="classTimePeriod.html">TimePeriod</a> &amp;tp, key val, <span class="keyword">const</span> string &amp;iname, <span class="keyword">const</span> string &amp;colname);
00206 
00208     string <a class="code" href="classSQLTable.html#SQLTablea32">sumColumn</a>(   <span class="keyword">const</span> <a class="code" href="classTimeStamp.html">TimeStamp</a> &amp;ts, <span class="keyword">const</span> string &amp;tpprefix,
00209                                         key val, <span class="keyword">const</span> string &amp;iname, <span class="keyword">const</span> string &amp;colname);
00210 
00212     string <a class="code" href="classSQLTable.html#SQLTablea32">sumColumn</a>(key val, <span class="keyword">const</span> string &amp;iname, <span class="keyword">const</span> string &amp;colname);
00213 
<a name="l00215"></a><a class="code" href="classSQLTable.html#SQLTablea36">00215</a>     data <a class="code" href="classSQLTable.html#SQLTablea36">operator[]</a>(key x) {
00216         <span class="keywordflow">return</span> <a class="code" href="classSQLTable.html#SQLTablea7">selectObject</a>(x, <a class="code" href="classSQLTable.html#SQLTableo3">indexname</a>);
00217     }
00218 
<a name="l00220"></a><a class="code" href="classSQLTable.html#SQLTablea37">00220</a>     pair&lt;key, data&gt; <a class="code" href="classSQLTable.html#SQLTablea36">operator[]</a>(size_t ind) {
00221         <span class="keywordflow">return</span> <a class="code" href="classSQLTable.html#SQLTablea7">selectObject</a>(ind);
00222     }
00223 
<a name="l00225"></a><a class="code" href="classSQLTable.html#SQLTablea38">00225</a>     <span class="keywordtype">bool</span> <a class="code" href="classSQLTable.html#SQLTablea38">isReady</a>() { <span class="keywordflow">return</span> <a class="code" href="classSQLTable.html#SQLTableo0">ready</a>; }
00226 
00228   <span class="keywordtype">void</span> <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(string msg);
00229 };
00230 
00236 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt;
<a name="l00237"></a><a class="code" href="classSQLTable.html#SQLTablea2">00237</a> <a class="code" href="classSQLTable.html#SQLTablea0">SQLTable&lt;key, data&gt;::SQLTable</a>(<span class="keyword">const</span> <a class="code" href="classSQLTable.html">SQLTable</a> &amp;source)
00238 :dbcon(source.dbcon),
00239 tablename(source.tablename),
00240 indexname(source.indexname),
00241 tsname(source.tsname),
00242 fieldnames(source.fieldnames),
00243 fieldtypes(source.fieldtypes),
00244 indices(source.indices),
00245 ready(source.ready),
00246 hasPrimaryKey(source.hasPrimaryKey) { }
00247 
00252 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; <a class="code" href="classSQLTable.html">SQLTable&lt;key, data&gt;</a>&amp;
<a name="l00253"></a><a class="code" href="classSQLTable.html#SQLTablea3">00253</a> <a class="code" href="classSQLTable.html#SQLTablea3">SQLTable&lt;key, data&gt;::operator=</a>(<span class="keyword">const</span> <a class="code" href="classSQLTable.html">SQLTable</a> &amp;source) {
00254     this-&gt;<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a> = source.<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>;
00255     this-&gt;<a class="code" href="classSQLTable.html#SQLTableo2">tablename</a> = source.<a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>;
00256     this-&gt;<a class="code" href="classSQLTable.html#SQLTableo3">indexname</a> = source.<a class="code" href="classSQLTable.html#SQLTableo3">indexname</a>;
00257     this-&gt;<a class="code" href="classSQLTable.html#SQLTableo4">tsname</a> = source.<a class="code" href="classSQLTable.html#SQLTableo4">tsname</a>;
00258     this-&gt;<a class="code" href="classSQLTable.html#SQLTableo5">fieldnames</a> = source.<a class="code" href="classSQLTable.html#SQLTableo5">fieldnames</a>;
00259     this-&gt;<a class="code" href="classSQLTable.html#SQLTableo6">fieldtypes</a> = source.<a class="code" href="classSQLTable.html#SQLTableo6">fieldtypes</a>;
00260   this-&gt;<a class="code" href="classSQLTable.html#SQLTableo7">indices</a> = source.<a class="code" href="classSQLTable.html#SQLTableo7">indices</a>;
00261     this-&gt;<a class="code" href="classSQLTable.html#SQLTableo0">ready</a> = source.<a class="code" href="classSQLTable.html#SQLTableo0">ready</a>;
00262     this-&gt;<a class="code" href="classSQLTable.html#SQLTableo8">hasPrimaryKey</a> = source.<a class="code" href="classSQLTable.html#SQLTableo8">hasPrimaryKey</a>;
00263 
00264     <span class="keywordflow">return</span> *<span class="keyword">this</span>;
00265 }
00266 
00279 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; 
00280 <a class="code" href="classSQLTable.html">SQLTable&lt;key, data&gt;</a>::SQLTable&lt;key, data&gt;(<a class="code" href="classSQLiteConnection.html">SQLiteConnection</a> *db,
00281                                                                                     <span class="keyword">const</span> string &amp;tname, <span class="keyword">const</span> string &amp;iname,
00282                                                                                     <span class="keyword">const</span> string &amp;ts,
00283                                                                                     vector&lt;string&gt; &amp;fnames,
00284                                           vector&lt;string&gt; &amp;ftypes,
00285                                           vector&lt;string&gt; &amp;indexnames,
00286                                                                                     <span class="keywordtype">bool</span> primarykey)
00287 :dbcon(db), tablename(tname),
00288 indexname(iname), tsname(ts), fieldnames(fnames), fieldtypes(ftypes),
00289 indices(indexnames), hasPrimaryKey(primarykey) {
00290 
00291 <span class="preprocessor">#ifdef DEBUG</span>
00292 <span class="preprocessor"></span>        stringstream debug;
00293 <span class="preprocessor">#endif</span>
00294 <span class="preprocessor"></span>
00295     <span class="keywordflow">if</span> (!dbcon-&gt;existsTable(tablename)) {
00296         <span class="keywordtype">int</span> rc;
00297     <span class="keywordtype">char</span> *zErrMsg = 0;
00298 
00299         stringstream sqlcmd;
00300     size_t i = 0;
00301 
00302         sqlcmd &lt;&lt; <span class="stringliteral">"CREATE TABLE "</span> &lt;&lt; tablename;
00303     sqlcmd &lt;&lt; <span class="stringliteral">" ( "</span> &lt;&lt; fieldnames[i] &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; fieldtypes[i];
00304     <span class="keywordflow">if</span> (hasPrimaryKey)
00305       sqlcmd &lt;&lt; <span class="stringliteral">" PRIMARY KEY"</span>;
00306     i++;
00307         <span class="keywordflow">while</span> (i &lt; fieldnames.size()) {
00308             sqlcmd &lt;&lt; <span class="stringliteral">", "</span> &lt;&lt; fieldnames[i] &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; fieldtypes[i];
00309             i++;
00310         }
00311         sqlcmd &lt;&lt; <span class="stringliteral">");"</span> &lt;&lt; endl;
00312     
00313 <span class="preprocessor">#ifdef DEBUG</span>
00314 <span class="preprocessor"></span>        logMsg(sqlcmd.str());
00315 <span class="preprocessor">#endif</span>
00316 <span class="preprocessor"></span>
00317     <span class="keywordflow">do</span> {
00318         rc = sqlite_exec (dbcon-&gt;getdb(), sqlcmd.str().c_str(), NULL, NULL, &amp;zErrMsg);
00319         <span class="keywordflow">if</span> (rc == SQLITE_OK)
00320         dbcon-&gt;logTransaction(sqlcmd.str());
00321       <span class="keywordflow">else</span> {
00322 <span class="preprocessor">#ifdef DEBUG</span>
00323 <span class="preprocessor"></span>        debug &lt;&lt; <span class="stringliteral">"Unable to create table: Error CODE = "</span> &lt;&lt; rc &lt;&lt; endl;
00324         debug &lt;&lt; <span class="stringliteral">"Command executed: "</span> &lt;&lt; endl &lt;&lt; sqlcmd.str() &lt;&lt; endl;
00325         debug &lt;&lt; <span class="stringliteral">"Error Msg : "</span> &lt;&lt; zErrMsg &lt;&lt; endl;
00326         logMsg(debug.str());
00327         ACE_OS::sleep(1);
00328 <span class="preprocessor">#endif</span>
00329 <span class="preprocessor"></span>      }
00330         } <span class="keywordflow">while</span> (rc == SQLITE_BUSY);
00331     } <span class="keywordflow">else</span> {
00332 <span class="preprocessor">#ifdef DEBUG</span>
00333 <span class="preprocessor"></span>        logMsg(string(<span class="stringliteral">"Table "</span> + tablename + <span class="stringliteral">" exists\n"</span>));
00334 <span class="preprocessor">#endif</span>
00335 <span class="preprocessor"></span>    }
00336 
00337   createIndices();
00338     ready = <span class="keyword">true</span>;
00339 }
00340 
00352 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; <span class="keywordtype">bool</span>
<a name="l00353"></a><a class="code" href="classSQLTable.html#SQLTablea5">00353</a> <a class="code" href="classSQLTable.html#SQLTablea5">SQLTable&lt;key, data&gt;::createIndices</a>() {
00354 
00355 <span class="preprocessor">#ifdef DEBUG</span>
00356 <span class="preprocessor"></span>        stringstream debug;
00357 <span class="preprocessor">#endif</span>
00358 <span class="preprocessor"></span>  stringstream index, sqlcmd;
00359   <span class="keywordtype">int</span> rc;
00360   <span class="keywordtype">char</span> *zErrMsg = 0;
00361   
00362   vector&lt;string&gt;::iterator i = <a class="code" href="classSQLTable.html#SQLTableo7">indices</a>.begin();
00363   
00364   <span class="keywordflow">while</span> (i != <a class="code" href="classSQLTable.html#SQLTableo7">indices</a>.end()) {
00365     sqlcmd.str(<span class="stringliteral">""</span>);
00366     index.str(<span class="stringliteral">""</span>);
00367     index &lt;&lt; <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a> &lt;&lt; <span class="stringliteral">"_index_"</span> &lt;&lt; *i;
00368 
00369     <span class="keywordflow">if</span> (<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona13">existsIndex</a>(index.str(), <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>)) {
00370         <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(string(<span class="stringliteral">"Index "</span> + index.str() + <span class="stringliteral">" exists\n"</span>));
00371     } <span class="keywordflow">else</span> {
00372       <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(string(<span class="stringliteral">"Index "</span> + index.str() + <span class="stringliteral">" does not exist\n"</span>));
00373 
00374       <span class="keywordflow">if</span> (<a class="code" href="classSQLTable.html#SQLTableo8">hasPrimaryKey</a> &amp;&amp; <a class="code" href="classSQLTable.html#SQLTableo3">indexname</a>.compare(*i) == 0)
00375         sqlcmd &lt;&lt; <span class="stringliteral">"CREATE UNIQUE INDEX "</span>;
00376       <span class="keywordflow">else</span>
00377             sqlcmd  &lt;&lt; <span class="stringliteral">"CREATE INDEX "</span>;
00378 
00379       sqlcmd  &lt;&lt; index.str() &lt;&lt; <span class="stringliteral">" ON "</span> &lt;&lt; <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>
00380               &lt;&lt; <span class="stringliteral">"("</span> &lt;&lt; *i &lt;&lt; <span class="stringliteral">");"</span> &lt;&lt; endl;
00381 
00382 <span class="preprocessor">#ifdef DEBUG</span>
00383 <span class="preprocessor"></span>        <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd.str());
00384 <span class="preprocessor">#endif</span>
00385 <span class="preprocessor"></span>
00386       <span class="keywordflow">do</span> {
00387             rc = sqlite_exec (<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd.str().c_str(), NULL, NULL, &amp;zErrMsg);
00388         <span class="keywordflow">if</span> (rc == SQLITE_OK)
00389           <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona11">logTransaction</a>(sqlcmd.str());
00390         <span class="keywordflow">else</span> {
00391 <span class="preprocessor">  #ifdef DEBUG</span>
00392 <span class="preprocessor"></span>          debug &lt;&lt; <span class="stringliteral">"Unable to create table: Error CODE = "</span> &lt;&lt; rc &lt;&lt; endl;
00393           debug &lt;&lt; <span class="stringliteral">"Command executed: "</span> &lt;&lt; endl &lt;&lt; sqlcmd.str() &lt;&lt; endl;
00394           debug &lt;&lt; <span class="stringliteral">"Error Msg : "</span> &lt;&lt; zErrMsg &lt;&lt; endl;
00395           <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(debug.str());
00396           ACE_OS::sleep(1);
00397 <span class="preprocessor">  #endif</span>
00398 <span class="preprocessor"></span>        }
00399         } <span class="keywordflow">while</span> (rc == SQLITE_BUSY);
00400     }
00401     i++;
00402   }
00403 
00404   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00405 }
00406 
00412 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; <span class="keywordtype">bool</span>
<a name="l00413"></a><a class="code" href="classSQLTable.html#SQLTablea6">00413</a> <a class="code" href="classSQLTable.html#SQLTablea6">SQLTable&lt;key, data&gt;::drop</a>() {
00414     <span class="keywordtype">int</span> rc;
00415 <span class="preprocessor">#ifdef DEBUG</span>
00416 <span class="preprocessor"></span>    stringstream debug;
00417 <span class="preprocessor">#endif</span>
00418 <span class="preprocessor"></span>
00419     stringstream sqlcmd;
00420     sqlcmd &lt;&lt; <span class="stringliteral">"DROP TABLE "</span> &lt;&lt; <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a> &lt;&lt; <span class="stringliteral">";"</span> &lt;&lt; endl;
00421 <span class="preprocessor">#ifdef DEBUG</span>
00422 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd.str());
00423 <span class="preprocessor">#endif</span>
00424 <span class="preprocessor"></span>
00425   <span class="keywordflow">do</span> {
00426     rc = sqlite_exec (<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd.str().c_str(), NULL, NULL, NULL);
00427       <span class="keywordflow">if</span> (rc == SQLITE_OK) {
00428       <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona11">logTransaction</a>(sqlcmd.str());
00429       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00430     } <span class="keywordflow">else</span> {
00431 <span class="preprocessor">#ifdef DEBUG</span>
00432 <span class="preprocessor"></span>            debug &lt;&lt; <span class="stringliteral">"Unable to drop table: Error CODE = "</span> &lt;&lt; rc &lt;&lt; endl;
00433               <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(debug.str());
00434 <span class="preprocessor">#endif</span>
00435 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;
00436     }
00437     } <span class="keywordflow">while</span> (rc == SQLITE_BUSY);
00438 }
00439 
00445 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; pair&lt;key, data&gt;
<a name="l00446"></a><a class="code" href="classSQLTable.html#SQLTablea7">00446</a> <a class="code" href="classSQLTable.html#SQLTablea7">SQLTable&lt;key, data&gt;::selectObject</a>(size_t index) {
00447 
00448     <span class="keywordtype">int</span> rc, nrow, ncol;
00449     <span class="keywordtype">char</span> *sqlcmd, **result;
00450     stringstream objstr;
00451 
00452     sqlcmd = sqlite_mprintf(<span class="stringliteral">"SELECT * FROM %s LIMIT 1 OFFSET %d;\n"</span>,
00453                                                     <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(), index);
00454 <span class="preprocessor">#ifdef EXTRADEBUG</span>
00455 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
00456 <span class="preprocessor">#endif</span>
00457 <span class="preprocessor"></span>
00458     rc = sqlite_get_table(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, &amp;result, &amp;nrow, &amp;ncol, NULL);
00459   free(sqlcmd);
00460     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
00461     <span class="keywordflow">if</span> (nrow) {
00462         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i &lt; ncol; i++) {
00463             objstr &lt;&lt; result[ncol +i];
00464               <span class="keywordflow">if</span> (i &lt; ncol -1)
00465                   objstr &lt;&lt; <span class="stringliteral">","</span>;
00466             }
00467         objstr &lt;&lt; endl;
00468 <span class="preprocessor">#ifdef EXTRADEBUG</span>
00469 <span class="preprocessor"></span>            <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(objstr.str());
00470 <span class="preprocessor">#endif</span>
00471 <span class="preprocessor"></span>        <span class="keywordflow">return</span> pair&lt;key, data&gt; (result[ncol], data(objstr.str()));
00472         }
00473 
00474         sqlite_free_table(result);
00475   } <span class="keywordflow">else</span>
00476         <span class="keywordflow">return</span> pair&lt;key, data&gt; (<span class="stringliteral">""</span>, data());
00477 
00478     <span class="keywordflow">return</span> pair&lt;key, data&gt; (<span class="stringliteral">""</span>, data());
00479 }
00480 
00486 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; data
<a name="l00487"></a><a class="code" href="classSQLTable.html#SQLTablea8">00487</a> <a class="code" href="classSQLTable.html#SQLTablea7">SQLTable&lt;key, data&gt;::selectObject</a>(key val, <span class="keyword">const</span> string &amp;iname) {
00488 
00489     <span class="keywordtype">int</span> rc, nrow, ncol;
00490     <span class="keywordtype">char</span> *sqlcmd, **result;
00491     stringstream objstr;
00492 
00493     sqlcmd = sqlite_mprintf(<span class="stringliteral">"SELECT * FROM %s WHERE %s = %Q LIMIT 1;\n"</span>,
00494                                                     <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(), iname.c_str(), val.c_str());
00495 <span class="preprocessor">#ifdef EXTRADEBUG</span>
00496 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
00497 <span class="preprocessor">#endif</span>
00498 <span class="preprocessor"></span>
00499     rc = sqlite_get_table(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, &amp;result, &amp;nrow, &amp;ncol, NULL);
00500   free(sqlcmd);
00501     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
00502     <span class="keywordflow">if</span> (nrow) {
00503         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i &lt; ncol; i++) {
00504             objstr &lt;&lt; result[ncol +i];
00505               <span class="keywordflow">if</span> (i &lt; ncol -1)
00506                   objstr &lt;&lt; <span class="stringliteral">","</span>;
00507             }
00508         objstr &lt;&lt; endl;
00509 <span class="preprocessor">#ifdef EXTRADEBUG</span>
00510 <span class="preprocessor"></span>        <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(objstr.str());
00511 <span class="preprocessor">#endif</span>
00512 <span class="preprocessor"></span>          <span class="keywordflow">return</span> data(objstr.str());
00513         }
00514 
00515     sqlite_free_table(result);
00516     } <span class="keywordflow">else</span>
00517     <span class="keywordflow">return</span> data();
00518   
00519     <span class="keywordflow">return</span> data();
00520 }
00521 
00527 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; map&lt;key, data&gt; *
<a name="l00528"></a><a class="code" href="classSQLTable.html#SQLTablea9">00528</a> <a class="code" href="classSQLTable.html#SQLTablea9">SQLTable&lt;key, data&gt;::selectObjects</a>(<span class="keyword">const</span> key &amp;from, <span class="keyword">const</span> key &amp;to, <span class="keyword">const</span> string &amp;iname) {
00529 
00530     <span class="keywordtype">int</span> rc, nrow, ncol;
00531     <span class="keywordtype">char</span> *sqlcmd, **result;
00532     stringstream objstr;
00533 
00534     map&lt;key, data&gt; *newmap = <span class="keyword">new</span> map&lt;key, data&gt;;
00535 
00536     sqlcmd = sqlite_mprintf(<span class="stringliteral">"SELECT * FROM %s WHERE (%s &gt;= %Q AND %s &lt;= %Q);\n"</span>,
00537                             <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(), iname.c_str(), from.c_str(), iname.c_str(), to.c_str());
00538 <span class="preprocessor">#ifdef EXTRADEBUG</span>
00539 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
00540 <span class="preprocessor">#endif</span>
00541 <span class="preprocessor"></span>
00542     rc = sqlite_get_table(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, &amp;result, &amp;nrow, &amp;ncol, NULL);
00543   free(sqlcmd);
00544     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
00545     <span class="keywordflow">if</span> (nrow) {
00546         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i &lt;= nrow; i++) {
00547             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=1; j &lt; ncol; j++) {
00548                     objstr &lt;&lt; result[i*ncol +j];
00549                 <span class="keywordflow">if</span> (j &lt; ncol -1)
00550                     objstr &lt;&lt; <span class="stringliteral">","</span>;
00551                 }
00552             objstr &lt;&lt; endl;
00553 <span class="preprocessor">#ifdef EXTRADEBUG</span>
00554 <span class="preprocessor"></span>            <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(objstr.str());
00555 <span class="preprocessor">#endif</span>
00556 <span class="preprocessor"></span>                data *newobj = <span class="keyword">new</span> data(objstr.str());
00557             string *index = <span class="keyword">new</span> string(result[i*ncol]);
00558             <span class="keywordflow">if</span> (newobj) {
00559                     newmap-&gt;insert(pair&lt;key, data&gt;(*index, *newobj));
00560                 <span class="keyword">delete</span> newobj;
00561             }
00562                 objstr.str(<span class="stringliteral">""</span>);
00563         }
00564         }
00565 
00566     sqlite_free_table(result);
00567       <span class="keywordflow">return</span> newmap;
00568     } <span class="keywordflow">else</span>
00569     <span class="keywordflow">return</span> NULL;
00570     
00571     <span class="keywordflow">return</span> NULL;
00572 }
00573 
00580 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; map&lt;key, data&gt; *
<a name="l00581"></a><a class="code" href="classSQLTable.html#SQLTablea10">00581</a> <a class="code" href="classSQLTable.html#SQLTablea9">SQLTable&lt;key, data&gt;::selectObjects</a>(<a class="code" href="classTimePeriod.html">TimePeriod</a> &amp;tp) {
00582 
00583     <span class="keywordtype">int</span> rc, nrow, ncol;
00584     <span class="keywordtype">char</span> *sqlcmd, **result;
00585     stringstream objstr;
00586 
00587     map&lt;key, data&gt; *newmap = <span class="keyword">new</span> map&lt;key, data&gt;;
00588 
00589     sqlcmd = sqlite_mprintf(<span class="stringliteral">"SELECT * FROM %s WHERE (%s &gt;= %d AND %s &lt;= %d);\n"</span>,
00590                             <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(), <a class="code" href="classSQLTable.html#SQLTableo4">tsname</a>.c_str(), tp.<a class="code" href="classTimePeriod.html#TimePerioda4">getBeginTS</a>().<a class="code" href="classTimeStamp.html#TimeStampa14">getTimeStamp</a>(),
00591                             <a class="code" href="classSQLTable.html#SQLTableo4">tsname</a>.c_str(), tp.<a class="code" href="classTimePeriod.html#TimePerioda5">getEndTS</a>().<a class="code" href="classTimeStamp.html#TimeStampa14">getTimeStamp</a>());
00592 <span class="preprocessor">#ifdef EXTRADEBUG</span>
00593 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
00594 <span class="preprocessor">#endif</span>
00595 <span class="preprocessor"></span>
00596     rc = sqlite_get_table(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, &amp;result, &amp;nrow, &amp;ncol, NULL);
00597   free(sqlcmd);
00598     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
00599     <span class="keywordflow">if</span> (nrow) {
00600         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i &lt;= nrow; i++) {
00601             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=1; j &lt; ncol; j++) {
00602                 objstr &lt;&lt; result[i*ncol +j];
00603                   <span class="keywordflow">if</span> (j &lt; ncol -1)
00604                       objstr &lt;&lt; <span class="stringliteral">","</span>;
00605                 }
00606             objstr &lt;&lt; endl;
00607 <span class="preprocessor">#ifdef EXTRADEBUG</span>
00608 <span class="preprocessor"></span>            <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(objstr.str());
00609 <span class="preprocessor">#endif</span>
00610 <span class="preprocessor"></span>            data *newobj = <span class="keyword">new</span> data(objstr.str());
00611               string *index = <span class="keyword">new</span> string(result[i*ncol]);
00612                 <span class="keywordflow">if</span> (newobj) {
00613                 newmap-&gt;insert(pair&lt;key, data&gt;(*index, *newobj));
00614                 <span class="keyword">delete</span> newobj;
00615             }
00616               objstr.str(<span class="stringliteral">""</span>);
00617             }
00618     }
00619 
00620       sqlite_free_table(result);
00621         <span class="keywordflow">return</span> newmap;
00622   } <span class="keywordflow">else</span>
00623       <span class="keywordflow">return</span> NULL;
00624   
00625     <span class="keywordflow">return</span> NULL;
00626 }
00627 
00634 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; map&lt;key, data&gt; *
<a name="l00635"></a><a class="code" href="classSQLTable.html#SQLTablea11">00635</a> <a class="code" href="classSQLTable.html#SQLTablea9">SQLTable&lt;key, data&gt;::selectObjects</a>( <a class="code" href="classTimeStamp.html">TimeStamp</a> &amp;ts,
00636                                                                         <span class="keyword">const</span> string &amp;tpprefix,
00637                                                                         <span class="keyword">const</span> string &amp;qtyname) {
00638 
00639     <span class="keywordtype">int</span> rc, nrow, ncol;
00640     <span class="keywordtype">char</span> *sqlcmd, **result;
00641     stringstream objstr;
00642     string tpbegin = tpprefix + <span class="stringliteral">"begin"</span>;
00643     string tpend = tpprefix + <span class="stringliteral">"end"</span>;
00644 
00645     map&lt;key, data&gt; *newmap = <span class="keyword">new</span> map&lt;key, data&gt;;
00646 
00647     sqlcmd = sqlite_mprintf(<span class="stringliteral">"SELECT * FROM %s WHERE (%s &lt;= %d AND %d &lt; %s AND %s != 0);\n"</span>,
00648                             <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(), tpbegin.c_str(), ts.<a class="code" href="classTimeStamp.html#TimeStampa14">getTimeStamp</a>(),
00649                             ts.<a class="code" href="classTimeStamp.html#TimeStampa14">getTimeStamp</a>(), tpend.c_str(), qtyname.c_str());
00650 <span class="preprocessor">#ifdef DEBUG</span>
00651 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
00652 <span class="preprocessor">#endif</span>
00653 <span class="preprocessor"></span>
00654     rc = sqlite_get_table(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, &amp;result, &amp;nrow, &amp;ncol, NULL);
00655   free(sqlcmd);
00656     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
00657     <span class="keywordflow">if</span> (nrow) {
00658         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i &lt;= nrow; i++) {
00659             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=1; j &lt; ncol; j++) {
00660                 objstr &lt;&lt; result[i*ncol +j];
00661                   <span class="keywordflow">if</span> (j &lt; ncol -1)
00662                         objstr &lt;&lt; <span class="stringliteral">","</span>;
00663             }
00664             objstr &lt;&lt; endl;
00665 <span class="preprocessor">#ifdef EXTRADEBUG</span>
00666 <span class="preprocessor"></span>            <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(objstr.str());
00667 <span class="preprocessor">#endif</span>
00668 <span class="preprocessor"></span>              data *newobj = <span class="keyword">new</span> data(objstr.str());
00669                 string *index = <span class="keyword">new</span> string(result[i*ncol]);
00670             <span class="keywordflow">if</span> (newobj) {
00671                 newmap-&gt;insert(pair&lt;key, data&gt;(*index, *newobj));
00672                 <span class="keyword">delete</span> newobj;
00673               }
00674                 objstr.str(<span class="stringliteral">""</span>);
00675         }
00676       }
00677 
00678         sqlite_free_table(result);
00679     <span class="keywordflow">return</span> newmap;
00680     } <span class="keywordflow">else</span>
00681     <span class="keywordflow">return</span> NULL;
00682   
00683     <span class="keywordflow">return</span> NULL;
00684 }
00685 
00691 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; map&lt;key, data&gt; *
<a name="l00692"></a><a class="code" href="classSQLTable.html#SQLTablea12">00692</a> <a class="code" href="classSQLTable.html#SQLTablea9">SQLTable&lt;key, data&gt;::selectObjects</a>(vector&lt;key&gt; &amp;objs, <span class="keyword">const</span> string &amp;iname) {
00693     <span class="keyword">typename</span> vector&lt;key&gt;::iterator i = objs.begin();
00694 
00695     map&lt;key, data&gt; *newmap = <span class="keyword">new</span> map&lt;key, data&gt;;
00696 
00697     <span class="keywordflow">while</span> (i != objs.end()) {
00698         data *newobj = <a class="code" href="classSQLTable.html#SQLTablea7">selectObject</a>(<a class="code" href="classSQLTable.html#SQLTableo3">indexname</a>.c_str(), *i);
00699         <span class="keywordflow">if</span> (newobj) {
00700             newmap-&gt;insert(pair&lt;key, data&gt;(*i, *newobj));
00701             <span class="keyword">delete</span> newobj;
00702         }
00703     }
00704     <span class="keywordflow">return</span> newmap;
00705 }
00706 
00712 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; map&lt;key, data&gt; *
<a name="l00713"></a><a class="code" href="classSQLTable.html#SQLTablea13">00713</a> <a class="code" href="classSQLTable.html#SQLTablea13">SQLTable&lt;key, data&gt;::selectAllObjects</a>() {
00714 
00715     <span class="keywordtype">int</span> rc, nrow, ncol;
00716     <span class="keywordtype">char</span> *sqlcmd, **result;
00717     stringstream objstr;
00718 
00719     map&lt;key, data&gt; *newmap = <span class="keyword">new</span> map&lt;key, data&gt;;
00720 
00721     sqlcmd = sqlite_mprintf(<span class="stringliteral">"SELECT * FROM %s;\n"</span>, <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str());
00722 <span class="preprocessor">#ifdef EXTRADEBUG</span>
00723 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
00724 <span class="preprocessor">#endif</span>
00725 <span class="preprocessor"></span>
00726     rc = sqlite_get_table(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, &amp;result, &amp;nrow, &amp;ncol, NULL);
00727   free(sqlcmd);
00728     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
00729     <span class="keywordflow">if</span> (nrow) {
00730         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i &lt;= nrow; i++) {
00731             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=1; j &lt; ncol; j++) {
00732                 objstr &lt;&lt; result[i*ncol +j];
00733                   <span class="keywordflow">if</span> (j &lt; ncol -1)
00734                         objstr &lt;&lt; <span class="stringliteral">","</span>;
00735             }
00736             objstr &lt;&lt; endl;
00737 <span class="preprocessor">#ifdef EXTRADEBUG</span>
00738 <span class="preprocessor"></span>            <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(objstr.str());
00739 <span class="preprocessor">#endif</span>
00740 <span class="preprocessor"></span>              data *newobj = <span class="keyword">new</span> data(objstr.str());
00741                 string *index = <span class="keyword">new</span> string(result[i*ncol]);
00742             <span class="keywordflow">if</span> (newobj) {
00743                 newmap-&gt;insert(pair&lt;key, data&gt;(*index, *newobj));
00744                 <span class="keyword">delete</span> newobj;
00745                 <span class="keyword">delete</span> index;
00746                 }
00747             objstr.str(<span class="stringliteral">""</span>);
00748         }
00749         }
00750 
00751     sqlite_free_table(result);
00752       <span class="keywordflow">return</span> newmap;
00753     } <span class="keywordflow">else</span>
00754     <span class="keywordflow">return</span> NULL;
00755   
00756     <span class="keywordflow">return</span> NULL;
00757 }
00758 
00765 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; map&lt;key, data&gt; *
<a name="l00766"></a><a class="code" href="classSQLTable.html#SQLTablea14">00766</a> <a class="code" href="classSQLTable.html#SQLTablea14">SQLTable&lt;key, data&gt;::selectDistinctObjects</a>(<a class="code" href="classTimePeriod.html">TimePeriod</a> &amp;tp, <span class="keyword">const</span> string &amp;iname) {
00767 
00768     <span class="keywordtype">int</span> rc, nrow, ncol;
00769     <span class="keywordtype">char</span> *sqlcmd, **result;
00770     stringstream objstr;
00771 
00772     map&lt;key, data&gt; *newmap = <span class="keyword">new</span> map&lt;key, data&gt;;
00773 
00774     sqlcmd = sqlite_mprintf(
00775                         <span class="stringliteral">"SELECT * FROM %s WHERE %s IN (SELECT DISTINCT %s FROM %s WHERE (%s &gt;= %d AND %s &lt;= %d);\n"</span>,
00776                             <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(), iname.c_str(), iname.c_str(),
00777                             <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(), <a class="code" href="classSQLTable.html#SQLTableo4">tsname</a>.c_str(), tp.<a class="code" href="classTimePeriod.html#TimePerioda4">getBeginTS</a>().<a class="code" href="classTimeStamp.html#TimeStampa14">getTimeStamp</a>(),
00778                             <a class="code" href="classSQLTable.html#SQLTableo4">tsname</a>.c_str(), tp.<a class="code" href="classTimePeriod.html#TimePerioda5">getEndTS</a>().<a class="code" href="classTimeStamp.html#TimeStampa14">getTimeStamp</a>());
00779 <span class="preprocessor">#ifdef EXTRADEBUG</span>
00780 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
00781 <span class="preprocessor">#endif</span>
00782 <span class="preprocessor"></span>
00783     rc = sqlite_get_table(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, &amp;result, &amp;nrow, &amp;ncol, NULL);
00784   free(sqlcmd);
00785     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
00786     <span class="keywordflow">if</span> (nrow) {
00787         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i &lt;= nrow; i++) {
00788             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=1; j &lt; ncol; j++) {
00789                     objstr &lt;&lt; result[i*ncol +j];
00790                 <span class="keywordflow">if</span> (j &lt; ncol -1)
00791                     objstr &lt;&lt; <span class="stringliteral">","</span>;
00792             }
00793               objstr &lt;&lt; endl;
00794 <span class="preprocessor">#ifdef EXTRADEBUG</span>
00795 <span class="preprocessor"></span>                <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(objstr.str());
00796 <span class="preprocessor">#endif</span>
00797 <span class="preprocessor"></span>            data *newobj = <span class="keyword">new</span> data(objstr.str());
00798             string *index = <span class="keyword">new</span> string(result[i*ncol]);
00799             <span class="keywordflow">if</span> (newobj) {
00800                 newmap-&gt;insert(pair&lt;key, data&gt;(*index, *newobj));
00801                   <span class="keyword">delete</span> newobj;
00802                 }
00803             objstr.str(<span class="stringliteral">""</span>);
00804         }
00805         }
00806 
00807     sqlite_free_table(result);
00808       <span class="keywordflow">return</span> newmap;
00809     } <span class="keywordflow">else</span>
00810     <span class="keywordflow">return</span> NULL;
00811   
00812     <span class="keywordflow">return</span> NULL;
00813 }
00814 
00819 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; map&lt;key, data&gt; *
<a name="l00820"></a><a class="code" href="classSQLTable.html#SQLTablea15">00820</a> <a class="code" href="classSQLTable.html#SQLTablea14">SQLTable&lt;key, data&gt;::selectDistinctObjects</a>(<span class="keyword">const</span> string &amp;iname) {
00821 
00822     <span class="keywordtype">int</span> rc, nrow, ncol;
00823     <span class="keywordtype">char</span> *sqlcmd, **result;
00824     stringstream objstr;
00825 
00826     map&lt;key, data&gt; *newmap = <span class="keyword">new</span> map&lt;key, data&gt;;
00827 
00828     sqlcmd = sqlite_mprintf(
00829                         <span class="stringliteral">"SELECT * FROM %s WHERE %s IN (SELECT DISTINCT %s FROM %s);\n"</span>,
00830                             <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(), iname.c_str(),
00831                             iname.c_str(), <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str());
00832 <span class="preprocessor">#ifdef EXTRADEBUG</span>
00833 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
00834 <span class="preprocessor">#endif</span>
00835 <span class="preprocessor"></span>
00836     rc = sqlite_get_table(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, &amp;result, &amp;nrow, &amp;ncol, NULL);
00837   free(sqlcmd);
00838     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
00839     <span class="keywordflow">if</span> (nrow) {
00840         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i &lt;= nrow; i++) {
00841             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=1; j &lt; ncol; j++) {
00842                 objstr &lt;&lt; result[i*ncol +j];
00843                   <span class="keywordflow">if</span> (j &lt; ncol -1)
00844                         objstr &lt;&lt; <span class="stringliteral">","</span>;
00845             }
00846             objstr &lt;&lt; endl;
00847 <span class="preprocessor">#ifdef EXTRADEBUG</span>
00848 <span class="preprocessor"></span>            <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(objstr.str());
00849 <span class="preprocessor">#endif</span>
00850 <span class="preprocessor"></span>                data *newobj = <span class="keyword">new</span> data(objstr.str());
00851             string *index = <span class="keyword">new</span> string(result[i*ncol]);
00852             <span class="keywordflow">if</span> (newobj) {
00853                 newmap-&gt;insert(pair&lt;key, data&gt;(*index, *newobj));
00854                 <span class="keyword">delete</span> newobj;
00855                 }
00856             objstr.str(<span class="stringliteral">""</span>);
00857         }
00858         }
00859 
00860     sqlite_free_table(result);
00861       <span class="keywordflow">return</span> newmap;
00862     } <span class="keywordflow">else</span>
00863     <span class="keywordflow">return</span> NULL;
00864 
00865     <span class="keywordflow">return</span> NULL;
00866 }
00867 
00877 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; <span class="keywordtype">void</span>
<a name="l00878"></a><a class="code" href="classSQLTable.html#SQLTablea16">00878</a> <a class="code" href="classSQLTable.html#SQLTablea16">SQLTable&lt;key, data&gt;::selectDistinctObjectsMap</a>(ostream&amp; out, <a class="code" href="classTimePeriod.html">TimePeriod</a> &amp;tp, <span class="keyword">const</span> string &amp;iname) {
00879 
00880     <span class="keywordtype">int</span> rc, nrow, ncol, counter = 0;
00881     <span class="keywordtype">char</span> *sqlcmd, **result;
00882     stringstream objstr;
00883     string index, oldindex(<span class="stringliteral">""</span>);
00884     data newobj;
00885 
00886     sqlcmd = sqlite_mprintf(
00887                         <span class="stringliteral">"SELECT %s,* FROM %s WHERE (%s &gt;= %d AND %s &lt;= %d) order by %s;\n"</span>,
00888                             iname.c_str(), <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(),
00889                             <a class="code" href="classSQLTable.html#SQLTableo4">tsname</a>.c_str(), tp.<a class="code" href="classTimePeriod.html#TimePerioda4">getBeginTS</a>().<a class="code" href="classTimeStamp.html#TimeStampa14">getTimeStamp</a>(),
00890                             <a class="code" href="classSQLTable.html#SQLTableo4">tsname</a>.c_str(), tp.<a class="code" href="classTimePeriod.html#TimePerioda5">getEndTS</a>().<a class="code" href="classTimeStamp.html#TimeStampa14">getTimeStamp</a>(),
00891                             iname.c_str());
00892 
00893 <span class="preprocessor">#ifdef DEBUG</span>
00894 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
00895 <span class="preprocessor">#endif</span>
00896 <span class="preprocessor"></span>
00897     rc = sqlite_get_table(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, &amp;result, &amp;nrow, &amp;ncol, NULL);
00898   free(sqlcmd);
00899     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
00900     <span class="keywordflow">if</span> (nrow) {
00901         <span class="keywordtype">int</span> excluded;
00902           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j &lt; ncol; j++) {
00903               <span class="keywordflow">if</span> (iname.compare(result[j]) == 0)
00904                   excluded = j;
00905             }
00906         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i &lt;= nrow; i++) {
00907             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=2; j &lt; ncol; j++) {
00908                 <span class="keywordflow">if</span> (j == excluded)
00909                     objstr &lt;&lt; result[i*ncol+1];
00910                   <span class="keywordflow">else</span>
00911                       objstr &lt;&lt; result[i*ncol+j];
00912                     <span class="keywordflow">if</span> (j &lt; ncol -1)
00913                     objstr &lt;&lt; <span class="stringliteral">","</span>;
00914             }
00915             objstr &lt;&lt; endl;
00916 <span class="preprocessor">#ifdef EXTRADEBUG</span>
00917 <span class="preprocessor"></span>              <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(objstr.str());
00918 <span class="preprocessor">#endif</span>
00919 <span class="preprocessor"></span>                newobj = data(objstr.str());
00920             index = result[i*ncol];
00921             out &lt;&lt; <span class="stringliteral">"&lt;TR&gt;"</span> &lt;&lt; endl &lt;&lt; <span class="stringliteral">"&lt;TD&gt;"</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">"&lt;TD&gt;"</span>;
00922             <span class="keywordflow">if</span> (index.compare(oldindex) != 0) {
00923                 counter = 1;
00924                   out &lt;&lt; index;
00925                 } <span class="keywordflow">else</span>
00926                 counter++;
00927             oldindex = index;
00928             out &lt;&lt; <span class="stringliteral">"&lt;TD&gt;"</span> &lt;&lt; counter &lt;&lt; data(objstr.str()).toHTMLString();
00929                 objstr.str(<span class="stringliteral">""</span>);
00930         }
00931       }
00932 
00933         sqlite_free_table(result);
00934   }
00935     
00936     <span class="keywordflow">return</span>;
00937 }
00938 
00947 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; <span class="keywordtype">void</span>
<a name="l00948"></a><a class="code" href="classSQLTable.html#SQLTablea17">00948</a> <a class="code" href="classSQLTable.html#SQLTablea16">SQLTable&lt;key, data&gt;::selectDistinctObjectsMap</a>(ostream&amp; out, <span class="keyword">const</span> string &amp;iname) {
00949 
00950     <span class="keywordtype">int</span> rc, nrow, ncol;
00951     <span class="keywordtype">char</span> *sqlcmd, **result;
00952     stringstream objstr;
00953     string index;
00954     data newobj;
00955 
00956     <a class="code" href="classSQLTable.html#SQLTableu0">sqlmap</a> *newmap = <span class="keyword">new</span> map&lt;key, vector&lt;data&gt; &gt;;
00957     <span class="keyword">typename</span> sqlmap::iterator p;
00958 
00959     sqlcmd = sqlite_mprintf(<span class="stringliteral">"SELECT %s,* FROM %s order by %s;\n"</span>,
00960                                                     iname.c_str(),<a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(), iname.c_str());
00961 
00962 <span class="preprocessor">#ifdef EXTRADEBUG</span>
00963 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
00964 <span class="preprocessor">#endif</span>
00965 <span class="preprocessor"></span>
00966     rc = sqlite_get_table(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, &amp;result, &amp;nrow, &amp;ncol, NULL);
00967   free(sqlcmd);
00968     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
00969     <span class="keywordflow">if</span> (nrow) {
00970         <span class="keywordtype">int</span> excluded;
00971           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j &lt; ncol; j++) {
00972               <span class="keywordflow">if</span> (iname.compare(result[j]) == 0)
00973                   excluded = j;
00974             }
00975         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i &lt;= nrow; i++) {
00976             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=2; j &lt; ncol; j++) {
00977                 <span class="keywordflow">if</span> (j == excluded)
00978                     objstr &lt;&lt; result[i*ncol+1];
00979                   <span class="keywordflow">else</span>
00980                       objstr &lt;&lt; result[i*ncol+j];
00981                     <span class="keywordflow">if</span> (j &lt; ncol -1)
00982                     objstr &lt;&lt; <span class="stringliteral">","</span>;
00983             }
00984             objstr &lt;&lt; endl;
00985 <span class="preprocessor">#ifdef EXTRADEBUG</span>
00986 <span class="preprocessor"></span>              <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(objstr.str());
00987 <span class="preprocessor">#endif</span>
00988 <span class="preprocessor"></span>                newobj = data(objstr.str());
00989             index = result[i*ncol];
00990             p = newmap-&gt;find(index);
00991             <span class="keywordflow">if</span> (p != newmap-&gt;end())
00992                 p-&gt;second.push_back(newobj);
00993                 <span class="keywordflow">else</span> {
00994                 vector&lt;data&gt; v;
00995                 v.push_back(newobj);
00996                 newmap-&gt;insert(pair&lt;key, vector&lt;data&gt; &gt;(index, v));
00997               }
00998                 objstr.str(<span class="stringliteral">""</span>);
00999         }
01000       }
01001 
01002         sqlite_free_table(result);
01003     <span class="keywordflow">return</span> newmap;
01004     } <span class="keywordflow">else</span>
01005     <span class="keywordflow">return</span> NULL;
01006   
01007     <span class="keywordflow">return</span> NULL;
01008 }
01009 
01017 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; <span class="keywordtype">void</span>
<a name="l01018"></a><a class="code" href="classSQLTable.html#SQLTablea18">01018</a> <a class="code" href="classSQLTable.html#SQLTablea18">SQLTable&lt;key, data&gt;::insertObject</a>(key val, data &amp;obj) {
01019 
01020     <span class="keywordtype">int</span> rc;
01021     <span class="keywordtype">char</span> *sqlcmd;
01022     <span class="keywordtype">char</span> *zErrMsg = 0;
01023 
01024 <span class="preprocessor">#ifdef DEBUG</span>
01025 <span class="preprocessor"></span>    stringstream debug;
01026 <span class="preprocessor">#endif</span>
01027 <span class="preprocessor"></span>
01028     <span class="keywordflow">if</span> (<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiono8">transactions_enabled</a> &amp;&amp; <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiono5">transactions</a> == 0)
01029         <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona6">beginTransaction</a>();
01030 
01031     sqlcmd = sqlite_mprintf(<span class="stringliteral">"INSERT INTO %s VALUES(%Q, %s);\n"</span>,
01032         <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(), val.c_str(), obj.insertString().c_str());
01033 <span class="preprocessor">#ifdef EXTRADEBUG</span>
01034 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
01035 <span class="preprocessor">#endif</span>
01036 <span class="preprocessor"></span>
01037     <span class="keywordflow">if</span> (<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiono8">transactions_enabled</a>) {
01038 <span class="preprocessor">#ifdef EXTRADEBUG</span>
01039 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(<span class="stringliteral">"Queueing into transaction...\n"</span>);
01040 <span class="preprocessor">#endif</span>
01041 <span class="preprocessor"></span>        <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiono7">transactioncmd</a> &lt;&lt; sqlcmd;
01042         <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiono5">transactions</a>++;
01043     } <span class="keywordflow">else</span> {
01044     <span class="keywordflow">do</span> {
01045         rc = sqlite_exec(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, NULL, NULL,    &amp;zErrMsg);
01046 
01047         <span class="keywordflow">if</span> (rc == SQLITE_OK) {
01048         <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiono6">conflicts</a> = 0;
01049         <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona11">logTransaction</a>(sqlcmd);
01050 <span class="preprocessor">#ifdef EXTRADEBUG</span>
01051 <span class="preprocessor"></span>            <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(<span class="stringliteral">"Data inserted successfully\n"</span>);
01052 <span class="preprocessor">#endif</span>
01053 <span class="preprocessor"></span>            } <span class="keywordflow">else</span> {
01054 
01055         <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiono6">conflicts</a>++;
01056         <span class="keywordflow">if</span> (rc == SQLITE_MISUSE || rc == SQLITE_CANTOPEN) {
01057             <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(<span class="stringliteral">"Reopenning database..."</span>);
01058           ACE_OS::sleep(1);
01059             <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona5">reconnect</a>();
01060               <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(<span class="stringliteral">"done\n"</span>);
01061         }
01062         
01063 <span class="preprocessor">#ifdef DEBUG</span>
01064 <span class="preprocessor"></span>            debug &lt;&lt; <span class="stringliteral">"Unable to INSERT data. Error CODE: "</span> &lt;&lt; rc &lt;&lt; endl;
01065         debug &lt;&lt; <span class="stringliteral">"Command executed: "</span> &lt;&lt; sqlcmd &lt;&lt; endl;
01066           debug &lt;&lt; <span class="stringliteral">"Error Msg : "</span> &lt;&lt; zErrMsg &lt;&lt; endl;
01067           <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(debug.str());
01068 <span class="preprocessor">#endif</span>
01069 <span class="preprocessor"></span>        }
01070       <span class="keywordflow">if</span> (rc == SQLITE_ERROR || rc == SQLITE_BUSY || rc == SQLITE_CANTOPEN || rc == SQLITE_MISUSE) {
01071         <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(<span class="stringliteral">"Retrying...\n"</span>);
01072         ACE_OS::sleep(1);
01073       }
01074       } <span class="keywordflow">while</span> (<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiono6">conflicts</a> &lt; <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectionu4SQLiteConnectionu1">max_conflicts</a> &amp;&amp; (rc == SQLITE_ERROR || rc == SQLITE_BUSY || rc == SQLITE_CANTOPEN || rc == SQLITE_MISUSE));
01075   }
01076 
01077     <span class="keywordflow">if</span> (<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiono5">transactions</a> == <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectionu4SQLiteConnectionu0">transactions_threshold</a>)
01078         <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona7">commitTransaction</a>();
01079   
01080     free(sqlcmd);
01081     <span class="keywordflow">return</span>;
01082 }
01083 
01089 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; <span class="keywordtype">void</span>
<a name="l01090"></a><a class="code" href="classSQLTable.html#SQLTablea19">01090</a> <a class="code" href="classSQLTable.html#SQLTablea19">SQLTable&lt;key, data&gt;::insertObjects</a>(map&lt;key, data&gt; &amp;objs) {
01091 
01092     <span class="keyword">typename</span> map&lt;key, data&gt;::iterator i = objs.begin();
01093     <span class="keywordflow">while</span> (i != objs.end()) {
01094         this-&gt;<a class="code" href="classSQLTable.html#SQLTablea18">insertObject</a>(i-&gt;first, i-&gt;second);
01095         i++;
01096     }
01097 }
01098 
01104 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; <span class="keywordtype">void</span>
<a name="l01105"></a><a class="code" href="classSQLTable.html#SQLTablea22">01105</a> <a class="code" href="classSQLTable.html#SQLTablea22">SQLTable&lt;key, data&gt;::deleteObject</a>(key &amp;val, <span class="keyword">const</span> string &amp;iname) {
01106 
01107     <span class="keywordtype">int</span> rc;
01108     <span class="keywordtype">char</span> *sqlcmd;
01109     stringstream objstr;
01110 
01111 <span class="preprocessor">#ifdef DEBUG</span>
01112 <span class="preprocessor"></span>    stringstream debug;
01113 <span class="preprocessor">#endif</span>
01114 <span class="preprocessor"></span>
01115     sqlcmd = sqlite_mprintf(<span class="stringliteral">"DELETE FROM %s WHERE %s = %Q;\n"</span>,
01116                                                     <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(), iname.c_str(), val.c_str());
01117 <span class="preprocessor">#ifdef EXTRADEBUG</span>
01118 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
01119 <span class="preprocessor">#endif</span>
01120 <span class="preprocessor"></span>
01121   <span class="keywordflow">do</span> {
01122     rc = sqlite_exec(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, NULL, NULL, NULL);
01123       free(sqlcmd);
01124     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
01125         <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona11">logTransaction</a>(sqlcmd.str());
01126 <span class="preprocessor">#ifdef EXTRADEBUG</span>
01127 <span class="preprocessor"></span>            <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(<span class="stringliteral">"Entry deleted successfully\n"</span>);
01128 <span class="preprocessor">#endif</span>
01129 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
01130       <span class="keywordflow">if</span> (rc == SQLITE_MISUSE) {
01131             <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(<span class="stringliteral">"Reopenning database..."</span>);
01132             <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona5">reconnect</a>();
01133             <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(<span class="stringliteral">"done\n"</span>);
01134       }
01135 
01136 <span class="preprocessor">#ifdef DEBUG</span>
01137 <span class="preprocessor"></span>        debug &lt;&lt; <span class="stringliteral">"Unable to DELETE data. Error CODE: "</span> &lt;&lt; rc &lt;&lt; endl;
01138           <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(debug.str());
01139 <span class="preprocessor">#endif</span>
01140 <span class="preprocessor"></span>    }
01141     <span class="keywordflow">if</span> (rc == SQLITE_ERROR || rc == SQLITE_BUSY || rc == SQLITE_CANTOPEN || rc == SQLITE_MISUSE) {
01142       <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(<span class="stringliteral">"Retrying...\n"</span>);
01143       ACE_OS::sleep(1);
01144     }
01145     } <span class="keywordflow">while</span> (rc == SQLITE_ERROR || rc == SQLITE_BUSY || rc == SQLITE_CANTOPEN || rc == SQLITE_MISUSE);
01146 
01147     <span class="keywordflow">return</span>;
01148 }
01149 
01155 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; <span class="keywordtype">void</span>
<a name="l01156"></a><a class="code" href="classSQLTable.html#SQLTablea23">01156</a> <a class="code" href="classSQLTable.html#SQLTablea23">SQLTable&lt;key, data&gt;::deleteObjects</a>(<span class="keyword">const</span> key &amp;from, <span class="keyword">const</span> key &amp;to, <span class="keyword">const</span> string &amp;iname) {
01157 
01158     <span class="keywordtype">int</span> rc;
01159     <span class="keywordtype">char</span> *sqlcmd;
01160     stringstream objstr;
01161 
01162 <span class="preprocessor">#ifdef DEBUG</span>
01163 <span class="preprocessor"></span>    stringstream debug;
01164 <span class="preprocessor">#endif</span>
01165 <span class="preprocessor"></span>
01166     sqlcmd = sqlite_mprintf(<span class="stringliteral">"DELETE FROM %s WHERE (%s &gt;= %Q AND %s &lt;= %Q);\n"</span>,
01167                             <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(), iname.c_str(), from.c_str(), iname.c_str(), to.c_str());
01168 <span class="preprocessor">#ifdef EXTRADEBUG</span>
01169 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
01170 <span class="preprocessor">#endif</span>
01171 <span class="preprocessor"></span>
01172   <span class="keywordflow">do</span> {
01173     rc = sqlite_exec(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, NULL, NULL, NULL);
01174       free(sqlcmd);
01175     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
01176         <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona11">logTransaction</a>(sqlcmd.str());
01177 <span class="preprocessor">#ifdef DEBUG</span>
01178 <span class="preprocessor"></span>            <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(<span class="stringliteral">"Entries deleted successfully\n"</span>);
01179 <span class="preprocessor">#endif</span>
01180 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
01181 <span class="preprocessor">#ifdef DEBUG</span>
01182 <span class="preprocessor"></span>        debug &lt;&lt; <span class="stringliteral">"Unable to DELETE data. Error CODE: "</span> &lt;&lt; rc &lt;&lt; endl;
01183           <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(debug.str());
01184 <span class="preprocessor">#endif</span>
01185 <span class="preprocessor"></span>    }
01186     <span class="keywordflow">if</span> (rc == SQLITE_BUSY || rc == SQLITE_CANTOPEN || rc == SQLITE_MISUSE) {
01187       <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(<span class="stringliteral">"Retrying...\n"</span>);
01188 <span class="comment">//      ACE_OS::sleep(1);</span>
01189     }
01190     } <span class="keywordflow">while</span> (rc == SQLITE_BUSY || rc == SQLITE_CANTOPEN || rc == SQLITE_MISUSE);
01191 
01192     <span class="keywordflow">return</span>;
01193 }
01194 
01200 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; <span class="keywordtype">void</span>
<a name="l01201"></a><a class="code" href="classSQLTable.html#SQLTablea24">01201</a> <a class="code" href="classSQLTable.html#SQLTablea23">SQLTable&lt;key, data&gt;::deleteObjects</a>(vector&lt;key&gt; &amp;objs, <span class="keyword">const</span> string &amp;iname) {
01202 
01203     <span class="keyword">typename</span> vector&lt;key&gt;::iterator i = objs.begin();
01204     <span class="keywordflow">while</span> (i != objs.end()) {
01205         <a class="code" href="classSQLTable.html#SQLTablea22">deleteObject</a>(<a class="code" href="classSQLTable.html#SQLTableo3">indexname</a>.c_str(), *i);
01206         i++;
01207     }
01208 }
01209 
01217 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; <span class="keywordtype">void</span>
<a name="l01218"></a><a class="code" href="classSQLTable.html#SQLTablea20">01218</a> <a class="code" href="classSQLTable.html#SQLTablea20">SQLTable&lt;key, data&gt;::updateObject</a>(<span class="keyword">const</span> key &amp;val, data &amp;obj, <span class="keyword">const</span> string &amp;iname) {
01219     <span class="keywordtype">int</span> rc;
01220     <span class="keywordtype">char</span> *sqlcmd;
01221 
01222 <span class="preprocessor">#ifdef DEBUG</span>
01223 <span class="preprocessor"></span>    stringstream debug;
01224 <span class="preprocessor">#endif</span>
01225 <span class="preprocessor"></span>  string index;
01226     <span class="keywordflow">if</span> (iname.compare(<span class="stringliteral">""</span>) == 0)
01227         index = <a class="code" href="classSQLTable.html#SQLTableo3">indexname</a>;
01228     <span class="keywordflow">else</span>
01229         index = iname;
01230 
01231     <span class="keywordflow">if</span> (<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiono8">transactions_enabled</a> &amp;&amp; <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiono5">transactions</a> == 0)
01232         <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona6">beginTransaction</a>();
01233 
01234     sqlcmd = sqlite_mprintf(<span class="stringliteral">"UPDATE %s SET %s WHERE %s = %Q;\n"</span>,
01235         <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(), obj.updateString().c_str(), index.c_str(), val.c_str());
01236 <span class="preprocessor">#ifdef EXTRADEBUG</span>
01237 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
01238 <span class="preprocessor">#endif</span>
01239 <span class="preprocessor"></span>
01240     <span class="keywordflow">if</span> (<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiono8">transactions_enabled</a>) {
01241         <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiono7">transactioncmd</a> &lt;&lt; sqlcmd;
01242         <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiono5">transactions</a>++;
01243     } <span class="keywordflow">else</span> {
01244     <span class="keywordflow">do</span> {
01245         rc = sqlite_exec(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, NULL, NULL, NULL);
01246 
01247         <span class="keywordflow">if</span> (rc == SQLITE_OK) {
01248         <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiono6">conflicts</a> = 0;
01249         <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona11">logTransaction</a>(sqlcmd);
01250 <span class="preprocessor">#ifdef EXTRADEBUG</span>
01251 <span class="preprocessor"></span>            <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(<span class="stringliteral">"Data updated successfully\n"</span>);
01252 <span class="preprocessor">#endif</span>
01253 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
01254         <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiono6">conflicts</a>++;
01255     
01256         <span class="keywordflow">if</span> (rc == SQLITE_MISUSE || rc == SQLITE_CANTOPEN) {
01257             <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(<span class="stringliteral">"Reopenning database..."</span>);
01258             <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona5">reconnect</a>();
01259               <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(<span class="stringliteral">"done\n"</span>);
01260         }
01261 
01262 <span class="preprocessor">#ifdef DEBUG</span>
01263 <span class="preprocessor"></span>            debug &lt;&lt; <span class="stringliteral">"Unable to UPDATE data. Error CODE: "</span> &lt;&lt; rc &lt;&lt; endl;
01264             <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(debug.str());
01265 <span class="preprocessor">#endif</span>
01266 <span class="preprocessor"></span>        }
01267       <span class="keywordflow">if</span> (rc == SQLITE_ERROR || rc == SQLITE_BUSY || rc == SQLITE_CANTOPEN || rc == SQLITE_MISUSE) {
01268         <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(<span class="stringliteral">"Retrying...\n"</span>);      
01269         ACE_OS::sleep(1);
01270       }
01271       } <span class="keywordflow">while</span> (<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiono6">conflicts</a> &lt; <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectionu4SQLiteConnectionu1">max_conflicts</a> &amp;&amp; (rc == SQLITE_BUSY || rc == SQLITE_CANTOPEN || rc == SQLITE_MISUSE));
01272     }
01273 
01274     <span class="keywordflow">if</span> (<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiono5">transactions</a> == <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectionu4SQLiteConnectionu0">transactions_threshold</a>)
01275         <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona7">commitTransaction</a>();
01276 
01277     free(sqlcmd);
01278     <span class="keywordflow">return</span>;
01279 }
01280 
01286 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; <span class="keywordtype">void</span>
<a name="l01287"></a><a class="code" href="classSQLTable.html#SQLTablea21">01287</a> <a class="code" href="classSQLTable.html#SQLTablea21">SQLTable&lt;key, data&gt;::updateObjects</a>(map&lt;key, data&gt; &amp;objs, <span class="keyword">const</span> string &amp;iname) {
01288     <span class="keyword">typename</span> map&lt;key, data&gt;::iterator i = objs.begin();
01289     <span class="keywordflow">while</span> (i != objs.end()) {
01290         <a class="code" href="classSQLTable.html#SQLTablea20">updateObject</a>(<a class="code" href="classSQLTable.html#SQLTableo3">indexname</a>.c_str(), i-&gt;first, i-&gt;second);
01291         i++;
01292     }
01293 }
01294 
01300 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; size_t
<a name="l01301"></a><a class="code" href="classSQLTable.html#SQLTablea25">01301</a> <a class="code" href="classSQLTable.html#SQLTablea29">SQLTable&lt;key, data&gt;::size</a>(key val, <span class="keyword">const</span> string &amp;iname) {
01302     <span class="keywordtype">int</span> rc, nrow, ncol;
01303     size_t count = 0;
01304     <span class="keywordtype">char</span> *sqlcmd, **result;
01305     stringstream objstr;
01306 
01307     sqlcmd = sqlite_mprintf(<span class="stringliteral">"SELECT COUNT(*) FROM %s WHERE %s = %Q;\n"</span>,
01308                                                     <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(), iname.c_str(), val.c_str());
01309 <span class="preprocessor">#ifdef DEBUG</span>
01310 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
01311 <span class="preprocessor">#endif</span>
01312 <span class="preprocessor"></span>
01313     rc = sqlite_get_table(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, &amp;result, &amp;nrow, &amp;ncol, NULL);
01314     free(sqlcmd);
01315     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
01316         <span class="keywordflow">if</span> (ncol) {
01317             count = strtoul(result[ncol], NULL, 10);
01318         }
01319         sqlite_free_table(result);
01320     }
01321     
01322     <span class="keywordflow">return</span> count;
01323 }
01324 
01330 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; size_t
<a name="l01331"></a><a class="code" href="classSQLTable.html#SQLTablea26">01331</a> <a class="code" href="classSQLTable.html#SQLTablea29">SQLTable&lt;key, data&gt;::size</a>(key from, key to, <span class="keyword">const</span> string &amp;iname) {
01332     <span class="keywordtype">int</span> rc, nrow, ncol;
01333     size_t count = 0;
01334     <span class="keywordtype">char</span> *sqlcmd, **result;
01335     stringstream objstr;
01336 
01337     sqlcmd = sqlite_mprintf(<span class="stringliteral">"SELECT COUNT(*) FROM %s WHERE (%s &gt;= %Q AND %s &lt;= %Q);\n"</span>,
01338                                                     <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(), iname.c_str(), from.c_str(), iname.c_str(), to.c_str());
01339 <span class="preprocessor">#ifdef DEBUG</span>
01340 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
01341 <span class="preprocessor">#endif</span>
01342 <span class="preprocessor"></span>
01343     rc = sqlite_get_table(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, &amp;result, &amp;nrow, &amp;ncol, NULL);
01344     free(sqlcmd);
01345     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
01346         <span class="keywordflow">if</span> (ncol) {
01347             count = strtoul(result[ncol], NULL, 10);
01348         }
01349         sqlite_free_table(result);
01350     }
01351 
01352     <span class="keywordflow">return</span> count;
01353 }
01354 
01360 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; size_t
<a name="l01361"></a><a class="code" href="classSQLTable.html#SQLTablea27">01361</a> <a class="code" href="classSQLTable.html#SQLTablea29">SQLTable&lt;key, data&gt;::size</a>(<a class="code" href="classTimePeriod.html">TimePeriod</a> &amp;tp) {
01362 
01363     <span class="keywordtype">int</span> rc, nrow, ncol;
01364     size_t count = 0;
01365     <span class="keywordtype">char</span> *sqlcmd, **result;
01366     stringstream objstr;
01367 
01368     sqlcmd = sqlite_mprintf(<span class="stringliteral">"SELECT COUNT(*) FROM %s WHERE (%s &gt;= %d AND %s &lt;= %d);\n"</span>,
01369                             <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(), <a class="code" href="classSQLTable.html#SQLTableo4">tsname</a>.c_str(), tp.<a class="code" href="classTimePeriod.html#TimePerioda4">getBeginTS</a>().<a class="code" href="classTimeStamp.html#TimeStampa14">getTimeStamp</a>(),
01370                             <a class="code" href="classSQLTable.html#SQLTableo4">tsname</a>.c_str(), tp.<a class="code" href="classTimePeriod.html#TimePerioda5">getEndTS</a>().<a class="code" href="classTimeStamp.html#TimeStampa14">getTimeStamp</a>());
01371 <span class="preprocessor">#ifdef DEBUG</span>
01372 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
01373 <span class="preprocessor">#endif</span>
01374 <span class="preprocessor"></span>
01375     rc = sqlite_get_table(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, &amp;result, &amp;nrow, &amp;ncol, NULL);
01376     free(sqlcmd);
01377     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
01378         <span class="keywordflow">if</span> (ncol) {
01379             count = strtoul(result[ncol], NULL, 10);
01380         }
01381         sqlite_free_table(result);
01382     }
01383 
01384     <span class="keywordflow">return</span> count;
01385 }
01386 
01392 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; size_t
<a name="l01393"></a><a class="code" href="classSQLTable.html#SQLTablea30">01393</a> <a class="code" href="classSQLTable.html#SQLTablea30">SQLTable&lt;key, data&gt;::sizeofDistinctObjects</a>(<a class="code" href="classTimePeriod.html">TimePeriod</a> &amp;tp, <span class="keyword">const</span> string &amp;iname) {
01394 
01395     <span class="keywordtype">int</span> rc, nrow, ncol;
01396     size_t count = 0;
01397     <span class="keywordtype">char</span> *sqlcmd, **result;
01398 
01399     sqlcmd = sqlite_mprintf(
01400                             <span class="stringliteral">"SELECT COUNT(*) FROM %s WHERE %s IN (SELECT DISTINCT %s FROM %s WHERE (%s &gt;= %d AND %s &lt;= %d));\n"</span>,
01401                             <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(), iname.c_str(), iname.c_str(),
01402                             <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(), <a class="code" href="classSQLTable.html#SQLTableo4">tsname</a>.c_str(), tp.<a class="code" href="classTimePeriod.html#TimePerioda4">getBeginTS</a>().<a class="code" href="classTimeStamp.html#TimeStampa14">getTimeStamp</a>(),
01403                             <a class="code" href="classSQLTable.html#SQLTableo4">tsname</a>.c_str(), tp.<a class="code" href="classTimePeriod.html#TimePerioda5">getEndTS</a>().<a class="code" href="classTimeStamp.html#TimeStampa14">getTimeStamp</a>());
01404 <span class="preprocessor">#ifdef DEBUG</span>
01405 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
01406 <span class="preprocessor">#endif</span>
01407 <span class="preprocessor"></span>
01408     rc = sqlite_get_table(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, &amp;result, &amp;nrow, &amp;ncol, NULL);
01409     free(sqlcmd);
01410     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
01411         <span class="keywordflow">if</span> (ncol) {
01412             count = strtoul(result[ncol], NULL, 10);
01413         }
01414         sqlite_free_table(result);
01415     }
01416 
01417     cout &lt;&lt; <span class="stringliteral">"count = "</span> &lt;&lt; count &lt;&lt; endl;
01418     <span class="keywordflow">return</span> count;
01419 }
01420 
01425 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; size_t
<a name="l01426"></a><a class="code" href="classSQLTable.html#SQLTablea31">01426</a> <a class="code" href="classSQLTable.html#SQLTablea30">SQLTable&lt;key, data&gt;::sizeofDistinctObjects</a>(<span class="keyword">const</span> string &amp;iname) {
01427 
01428     <span class="keywordtype">int</span> rc, nrow, ncol;
01429     size_t count = 0;
01430     <span class="keywordtype">char</span> *sqlcmd, **result;
01431 
01432     sqlcmd = sqlite_mprintf(
01433                             <span class="stringliteral">"SELECT COUNT(*) FROM %s WHERE %s IN (SELECT DISTINCT %s FROM %s);\n"</span>,
01434                             <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(), iname.c_str(),
01435                             iname.c_str(), <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str());
01436 <span class="preprocessor">#ifdef DEBUG</span>
01437 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
01438 <span class="preprocessor">#endif</span>
01439 <span class="preprocessor"></span>
01440     rc = sqlite_get_table(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, &amp;result, &amp;nrow, &amp;ncol, NULL);
01441     free(sqlcmd);
01442     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
01443         <span class="keywordflow">if</span> (ncol) {
01444             count = strtoul(result[ncol], NULL, 10);
01445         }
01446         sqlite_free_table(result);
01447     }
01448 
01449     cout &lt;&lt; <span class="stringliteral">"count = "</span> &lt;&lt; count &lt;&lt; endl;
01450     <span class="keywordflow">return</span> count;
01451 }
01452 
01459 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; size_t
<a name="l01460"></a><a class="code" href="classSQLTable.html#SQLTablea28">01460</a> <a class="code" href="classSQLTable.html#SQLTablea29">SQLTable&lt;key, data&gt;::size</a>(  <span class="keyword">const</span> <a class="code" href="classTimeStamp.html">TimeStamp</a> &amp;ts,
01461                                                         <span class="keyword">const</span> string &amp;tpprefix,
01462                                                         <span class="keyword">const</span> string &amp;qtyname) {
01463 
01464     <span class="keywordtype">int</span> rc, nrow, ncol;
01465     size_t count = 0;
01466     <span class="keywordtype">char</span> *sqlcmd, **result;
01467     string tpbegin = tpprefix + <span class="stringliteral">"begin"</span>;
01468     string tpend = tpprefix + <span class="stringliteral">"end"</span>;
01469 
01470     sqlcmd = sqlite_mprintf(<span class="stringliteral">"SELECT COUNT(*) FROM %s WHERE (%s &lt;= %d AND %d &lt; %s AND %q != 0);\n"</span>,
01471                             <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(),
01472                             tpbegin.c_str(), ts.<a class="code" href="classTimeStamp.html#TimeStampa14">getTimeStamp</a>(),
01473                             ts.<a class="code" href="classTimeStamp.html#TimeStampa14">getTimeStamp</a>(), tpend.c_str(), qtyname.c_str());
01474 <span class="preprocessor">#ifdef EXTRADEBUG</span>
01475 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
01476 <span class="preprocessor">#endif</span>
01477 <span class="preprocessor"></span>
01478     rc = sqlite_get_table(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, &amp;result, &amp;nrow, &amp;ncol, NULL);
01479     free(sqlcmd);
01480     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
01481         <span class="keywordflow">if</span> (ncol) {
01482             count = strtoul(result[ncol], NULL, 10);
01483         }
01484         sqlite_free_table(result);
01485     }
01486 
01487     <span class="keywordflow">return</span> count;
01488 }
01489 
01494 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; size_t
<a name="l01495"></a><a class="code" href="classSQLTable.html#SQLTablea29">01495</a> <a class="code" href="classSQLTable.html#SQLTablea29">SQLTable&lt;key, data&gt;::size</a>() {
01496     <span class="keywordtype">int</span> rc, nrow, ncol;
01497     size_t count = 0;
01498     <span class="keywordtype">char</span> *sqlcmd, **result;
01499 
01500     sqlcmd = sqlite_mprintf(<span class="stringliteral">"SELECT COUNT(*) FROM %s;\n"</span>, <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str());
01501 <span class="preprocessor">#ifdef EXTRADEBUG</span>
01502 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
01503 <span class="preprocessor">#endif</span>
01504 <span class="preprocessor"></span>
01505     rc = sqlite_get_table(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, &amp;result, &amp;nrow, &amp;ncol, NULL);
01506     free(sqlcmd);
01507     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
01508         <span class="keywordflow">if</span> (ncol) {
01509             count = strtoul(result[ncol], NULL, 10);
01510         }
01511         sqlite_free_table(result);
01512     }
01513     
01514     <span class="keywordflow">return</span> count;
01515 }
01516 
01522 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; string
<a name="l01523"></a><a class="code" href="classSQLTable.html#SQLTablea32">01523</a> <a class="code" href="classSQLTable.html#SQLTablea32">SQLTable&lt;key, data&gt;::sumColumn</a>(key from, key to, <span class="keyword">const</span> string &amp;iname, <span class="keyword">const</span> string &amp;colname) {
01524     <span class="keywordtype">int</span> rc, nrow, ncol;
01525     <span class="keywordtype">char</span> *sqlcmd, **result;
01526     string res;
01527 
01528     sqlcmd = sqlite_mprintf(<span class="stringliteral">"SELECT SUM(%s) FROM %s WHERE (%s &gt;= %Q AND %s &lt;= %Q);\n"</span>,
01529                                                     colname.c_str(), <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(),
01530                                                     iname.c_str(), from.c_str(),
01531                                                     iname.c_str(), to.c_str());
01532 <span class="preprocessor">#ifdef DEBUG</span>
01533 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
01534 <span class="preprocessor">#endif</span>
01535 <span class="preprocessor"></span>
01536     rc = sqlite_get_table(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, &amp;result, &amp;nrow, &amp;ncol, NULL);
01537     free(sqlcmd);
01538     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
01539         <span class="keywordflow">if</span> (ncol) {
01540             res = result[ncol];
01541         } <span class="keywordflow">else</span>
01542             res = <span class="stringliteral">"N/A"</span>;
01543         sqlite_free_table(result);
01544     }
01545 
01546     <span class="keywordflow">return</span> res;
01547 }
01548 
01554 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; string
<a name="l01555"></a><a class="code" href="classSQLTable.html#SQLTablea33">01555</a> <a class="code" href="classSQLTable.html#SQLTablea32">SQLTable&lt;key, data&gt;::sumColumn</a>( <a class="code" href="classTimePeriod.html">TimePeriod</a> &amp;tp, key val,
01556                                                                 <span class="keyword">const</span> string &amp;iname, <span class="keyword">const</span> string &amp;colname) {
01557 
01558     <span class="keywordtype">int</span> rc, nrow, ncol;
01559     <span class="keywordtype">char</span> *sqlcmd, **result;
01560     stringstream objstr;
01561     string res;
01562 
01563     sqlcmd = sqlite_mprintf(<span class="stringliteral">"SELECT SUM(%s) FROM %s WHERE (%s &gt;= %d AND %s &lt;= %d AND %s = %Q);\n"</span>,
01564                             colname.c_str(), <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(),
01565                             <a class="code" href="classSQLTable.html#SQLTableo4">tsname</a>.c_str(), tp.<a class="code" href="classTimePeriod.html#TimePerioda4">getBeginTS</a>().<a class="code" href="classTimeStamp.html#TimeStampa14">getTimeStamp</a>(),
01566                             <a class="code" href="classSQLTable.html#SQLTableo4">tsname</a>.c_str(), tp.<a class="code" href="classTimePeriod.html#TimePerioda5">getEndTS</a>().<a class="code" href="classTimeStamp.html#TimeStampa14">getTimeStamp</a>(),
01567                             iname.c_str(), val.c_str());
01568 <span class="preprocessor">#ifdef EXTRADEBUG</span>
01569 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
01570 <span class="preprocessor">#endif</span>
01571 <span class="preprocessor"></span>
01572     rc = sqlite_get_table(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, &amp;result, &amp;nrow, &amp;ncol, NULL);
01573     free(sqlcmd);
01574     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
01575         <span class="keywordflow">if</span> (ncol) {
01576             res = result[ncol];
01577         } <span class="keywordflow">else</span>
01578             res = <span class="stringliteral">"N/A"</span>;
01579         sqlite_free_table(result);
01580     }
01581 
01582     <span class="keywordflow">return</span> res;
01583 }
01584 
01591 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; string
<a name="l01592"></a><a class="code" href="classSQLTable.html#SQLTablea34">01592</a> <a class="code" href="classSQLTable.html#SQLTablea32">SQLTable&lt;key, data&gt;::sumColumn</a>( <span class="keyword">const</span> <a class="code" href="classTimeStamp.html">TimeStamp</a> &amp;ts,
01593                                                         <span class="keyword">const</span> string &amp;tpprefix,
01594                                                         key val, <span class="keyword">const</span> string &amp;iname, 
01595                                                         <span class="keyword">const</span> string &amp;colname) {
01596 
01597     <span class="keywordtype">int</span> rc, nrow, ncol;
01598     <span class="keywordtype">char</span> *sqlcmd, **result;
01599     stringstream objstr;
01600     string tpbegin = tpprefix + <span class="stringliteral">"begin"</span>;
01601     string tpend = tpprefix + <span class="stringliteral">"end"</span>;
01602     string res;
01603 
01604     map&lt;key, data&gt; *newmap = <span class="keyword">new</span> map&lt;key, data&gt;;
01605 
01606         sqlcmd = sqlite_mprintf(<span class="stringliteral">"SELECT SUM(%s) FROM %s WHERE (%s &lt;= %d AND %d &lt; %s AND %s != %Q);\n"</span>,
01607                             colname.c_str(), <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(),
01608                             tpbegin.c_str(), ts.<a class="code" href="classTimeStamp.html#TimeStampa14">getTimeStamp</a>(),
01609                             ts.<a class="code" href="classTimeStamp.html#TimeStampa14">getTimeStamp</a>(), tpend.c_str(),
01610                             iname.c_str(), val.c_str());
01611 <span class="preprocessor">#ifdef EXTRADEBUG</span>
01612 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
01613 <span class="preprocessor">#endif</span>
01614 <span class="preprocessor"></span>
01615     rc = sqlite_get_table(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, &amp;result, &amp;nrow, &amp;ncol, NULL);
01616     free(sqlcmd);
01617     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
01618         <span class="keywordflow">if</span> (ncol) {
01619             res = result[ncol];
01620         } <span class="keywordflow">else</span>
01621             res = <span class="stringliteral">"N/A"</span>;
01622         sqlite_free_table(result);
01623     }
01624 
01625     <span class="keywordflow">return</span> res;
01626 }
01627 
01633 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; string
<a name="l01634"></a><a class="code" href="classSQLTable.html#SQLTablea35">01634</a> <a class="code" href="classSQLTable.html#SQLTablea32">SQLTable&lt;key, data&gt;::sumColumn</a>(key val, <span class="keyword">const</span> string &amp;iname, <span class="keyword">const</span> string &amp;colname) {
01635     <span class="keywordtype">int</span> rc, nrow, ncol;
01636     <span class="keywordtype">char</span> *sqlcmd, **result;
01637     string res;
01638 
01639     sqlcmd = sqlite_mprintf(<span class="stringliteral">"SELECT SUM(%s) FROM %s WHERE %s = %Q;\n"</span>,
01640                                                     colname.c_str(), <a class="code" href="classSQLTable.html#SQLTableo2">tablename</a>.c_str(),
01641                                                     iname.c_str(), val.c_str());
01642 <span class="preprocessor">#ifdef EXTRADEBUG</span>
01643 <span class="preprocessor"></span>    <a class="code" href="classSQLTable.html#SQLTablea39">logMsg</a>(sqlcmd);
01644 <span class="preprocessor">#endif</span>
01645 <span class="preprocessor"></span>
01646     rc = sqlite_get_table(<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiona3">getdb</a>(), sqlcmd, &amp;result, &amp;nrow, &amp;ncol, NULL);
01647     free(sqlcmd);
01648     <span class="keywordflow">if</span> (rc == SQLITE_OK) {
01649         <span class="keywordflow">if</span> (ncol) {
01650             res = result[ncol];
01651         } <span class="keywordflow">else</span>
01652             res = <span class="stringliteral">"N/A"</span>;
01653         sqlite_free_table(result);
01654     }
01655 
01656     <span class="keywordflow">return</span> res;
01657 }
01658 
01665 <span class="keyword">template</span>&lt;<span class="keyword">class</span> key, <span class="keyword">class</span> data&gt; <span class="keywordtype">void</span>
<a name="l01666"></a><a class="code" href="classSQLTable.html#SQLTablea39">01666</a> <a class="code" href="classSQLTable.html#SQLTablea39">SQLTable&lt;key, data&gt;::logMsg</a>(string msg) {
01667   <span class="keywordflow">if</span> (<a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiono2">logger</a>)
01668     <a class="code" href="classSQLTable.html#SQLTableo1">dbcon</a>-&gt;<a class="code" href="classSQLiteConnection.html#SQLiteConnectiono2">logger</a>-&gt;<a class="code" href="classLogger.html#Loggera7">logMsg</a>(msg);
01669   <span class="keywordflow">else</span>
01670     cout &lt;&lt; msg;
01671 
01672   <span class="keywordflow">return</span>;
01673 }
01674 
01675 
01676 <span class="preprocessor">#endif</span>
</pre></div><hr><address style="align: right;"><small>Generated on Tue Aug 26 00:00:07 2003 by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
